name: CI

on:
  push:
    branches: ["main"]
  pull_request:

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ["3.10", "3.11", "3.12"]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip

      - name: Set up Pandoc
        uses: r-lib/actions/setup-pandoc@v2
        with:
          pandoc-version: "3.6.4"

      - name: Show tool versions
        run: |
          python --version
          pandoc --version

      - name: Install package
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e .

      - name: Run tests
        run: python -m unittest -q

      - name: CLI smoke tests
        shell: python
        run: |
          from pathlib import Path
          import shutil
          import subprocess
          import sys
          import sysconfig

          commands = ["dmc", "docx-comments", "docx2md", "md2docx", "d2m", "m2d"]
          scripts_dir = Path(sysconfig.get_path("scripts") or "")
          is_windows = sys.platform.startswith("win")

          def resolve_script(command: str) -> str:
              candidates = [scripts_dir / command]
              if is_windows:
                  candidates.extend(
                      [
                          scripts_dir / f"{command}.exe",
                          scripts_dir / f"{command}.bat",
                          scripts_dir / f"{command}-script.py",
                      ]
                  )
              for candidate in candidates:
                  if candidate.exists():
                      return str(candidate)
              path_hit = shutil.which(command)
              if path_hit:
                  return path_hit
              raise SystemExit(
                  f"missing console script: {command}\n"
                  f"checked scripts dir: {scripts_dir}\n"
                  f"checked PATH via shutil.which"
              )

          for command in commands:
              binary = resolve_script(command)
              proc = subprocess.run([binary, "--help"], capture_output=True, text=True)
              if proc.returncode != 0:
                  raise SystemExit(
                      f"{command} --help failed with exit {proc.returncode}\n"
                      f"resolved script: {binary}\n"
                      f"stdout:\n{proc.stdout}\n"
                      f"stderr:\n{proc.stderr}"
                  )

          for args in (["-m", "dmc", "--help"], ["-m", "dmc", "docx2md", "--help"], ["-m", "dmc", "md2docx", "--help"]):
              proc = subprocess.run([sys.executable, *args], capture_output=True, text=True)
              if proc.returncode != 0:
                  raise SystemExit(
                      f"python {' '.join(args)} failed with exit {proc.returncode}\n"
                      f"stdout:\n{proc.stdout}\n"
                      f"stderr:\n{proc.stderr}"
                  )
